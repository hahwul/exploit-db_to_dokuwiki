# -*- coding: utf-8 -*-

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
# Exploit-db to Dokuwiki                              #
#   >> code by hahwul(www.hahwul.com)                 #
#   >> description                                    #
#      - exploit-db(edb) convert to dokuwiki template #
#      - generated dokuwiki file(.txt), start page    #
#      - c3chart graph                                #
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
# Usage: python edbtodoku.py                          #
#  + install tablewidth plugin(dokuwiki plugin)       #
#  + install c3chart plugin(dokuwiki plugin)          #
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 


import csv
import os
from datetime import datetime

########### CONFIG ############
doku_edb_path = "/vaw/www/html/dokuwiki/data/pages/exploit/"
exp_git_path = "/tmp/exploit-database/  [your exploit-database source]" #git clone https://github.com/offensive-security/exploit-database
####################################
#Git update
os.system(exp_git_path+"/searchsploit -u")

####################################
matrix = []
f = open(exp_git_path+'/files.csv','r')
#lastnumfp = open('./lastnum','r')
#lastnum = lastnumfp.read()
#lastnum = int(lastnum)
csvReader = csv.reader(f)

for row in csvReader:
	matrix.append(row)
	
# matrix[x][0] = edb id
# matrix[x][1] = locate
# matrix[x][2] = title 
# matrix[x][3] = date
# matrix[x][4] = author
# matrix[x][5] = platform
# matrix[x][6] = type
# matrix[x][7] = ? 80
summary_form="====== Exploit Database. ======\n[updated . <time!!>]<graph-graph><graph-graph2>​​​​​​\n----\n\nNewest 100.\n|< 100% 50px - 1em 1em 7em >|\n^ EID  ^  Vulnerability  ^  Type  ^  Platform  ^  Date  ^"
graph_data="<c3 width=45% align=left>\n{\n  data: {\n    columns: "

count_list = []
count_inlist = []
#  count_list
#  ---------------------------------
# |count_inlist(eytpe | count) |
#  ---------------------------------

#| [[edb:edb1|]]  |  2  |  3  |  4  |  5  |
#| 999999999999  |  2  |  3  |  4  |  5  |"

print "Generate Database"
print "MAX QUEUE: ["+str(len(matrix))+"]"

i=1
while(i<len(matrix)):
	eid = matrix[i][0]
	locate = matrix[i][1]
	title = matrix[i][2]
	date = matrix[i][3]
	author = matrix[i][4]
	platform = matrix[i][5]
	etype = matrix[i][6]
	df = open(exp_git_path+'/'+locate,'r')
	data = df.read()
	
	if count_list.count(etype):
		count_inlist[count_list.index(etype)][0] += 1
	else:
		count_list.append(etype)
		count_inlist.append([0,etype])
	
	if(i>len(matrix)-100):
		summary_form = summary_form.replace("^  Date  ^","^  Date  ^\n|[[exploit:eid"+eid+"|]] | "+title+" | "+etype+" | "+platform+" | "+date+" | ")
	
	wf = open(doku_edb_path+'/eid'+eid+'.txt','w')
	Buffer = "**"+title+"**\n----\nThis vulnerability name is \""+title+"\".\n\nIt's using on "+platform+" system, type is "+etype+" exploit\n"+"  Exploit Author: "+author+"\n  Date: "+date+"\n  Type: "+etype+"\n  Platform: "+platform+"\n\n<code>\n"+data+"</code>\n"
	
	wf.write(Buffer)
	
	print "QUEUE: ["+str(i)+"] ... OK"
	wf.close()
	lastnum = eid
	i=i+1
f.close()
count_inlist.sort()
count_inlist.reverse()

i=0
while i<len(count_inlist):
	count_inlist[i].reverse()
	i+=1

graph_data = graph_data+str(count_inlist)+",\n    type : 'bar',\n  }\n}\n</c3>"
graph_data2 = graph_data 

graph_data2 = graph_data2.replace("bar","pie")
graph_data2 = graph_data2.replace("left","right")


summary_form = summary_form.replace("<graph-graph>",graph_data)
summary_form = summary_form.replace("<graph-graph2>",graph_data2)
summary_form = summary_form.replace("<time!!>",datetime.today().strftime("%Y/%m/%d"))

print summary_form
print "Generate Summary data"
f = open(doku_edb_path+'/start.txt','w')
f.write(summary_form)
f.close()




